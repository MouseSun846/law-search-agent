# 智能合同法律检索 Agent

本项目是一个基于 `LangGraph` 和 `deepagents` 构建的智能法律检索系统。它采用多 Agent 协作的模式，旨在根据用户的法律问题，精准地从本地法律文档库中检索、评估并匹配最相关的法律条文。

UI 展示界面采用 [deep-agents-ui](https://github.com/langchain-ai/deep-agents-ui)。

## ✨ 功能特性

- **多 Agent 协作**：系统由协调者、检索者和评估者三个 Agent 组成，各司其职，高效协作。
- **智能检索与评估**：不仅仅是关键词匹配，系统能够理解问题，评估检索结果，并根据评估反馈进行多轮迭代优化。
- **高效处理大文件**：内置智能文本分块工具，可以高效处理大型法律文档，避免超出模型上下文限制。
- **限定范围检索**：所有文件操作都严格限制在指定的 `LAW_DOCS_PATH` 目录下，确保安全可控。
- **状态化与可追溯**：基于 `LangGraph` 构建，整个检索评估流程是状态化的，便于调试和追溯。
- **前端集成**：可以无缝对接到 `deep-agents-ui`，提供友好的用户交互界面。

## 🤖 系统架构

本系统采用“协调者-执行者”（Coordinator-Executor）模式，其核心工作流程如下：

1.  **用户输入**：用户提出一个关于合同的法律问题。
2.  **协调 Agent (`LegalContractCoordinator`)**：作为总指挥，接收用户问题。
    -   **生成关键词**：分析问题，生成初步的检索关键词。
    -   **任务派发**：调用检索 Agent 开始工作。
3.  **检索 Agent (`legal-retriever-agent`)**：作为执行者，负责在法律文档库中查找信息。
    -   **文件扫描**：使用 `get_all_files` 工具获取所有可用法律文件列表。
    -   **文件分块预览**：使用 `get_file_chunks_info` 工具快速了解文件结构，定位可能相关的文本块。
    -   **精准读取**：使用 `read_file_chunk` 工具读取最相关文本块的内容。
    -   **返回候选条文**：将找到的候选法律条文列表返回给协调者。
4.  **协调 Agent**：接收到候选条文后，再次派发任务给评估 Agent。
5.  **评估 Agent (`legal-evaluator-agent`)**：作为评审员，负责评估检索结果的质量。
    -   **逻辑比对**：将用户问题与每一条候选法条进行语义和逻辑上的比对。
    -   **生成评估报告**：输出 `MATCH` (匹配) 或 `MISMATCH` (不匹配) 的 JSON 格式评估报告，并附上详细理由。
6.  **协调 Agent (决策与循环)**：
    -   如果结果是 `MATCH`，则整合信息，生成最终答案并结束流程。
    -   如果结果是 `MISMATCH`，则根据评估报告中的失败原因，**优化检索关键词**，然后重新启动新一轮的检索-评估循环（最多重试 3 次）。
    -   如果 3 次尝试后仍未成功，则向用户报告无法找到匹配的法律依据。

## 🛠️ 组件说明

### Agents

-   **`LegalContractCoordinator` (协调者)**
    -   **职责**：整个工作流的“大脑”，负责任务分解、Agent 调度、逻辑判断和循环重试。
    -   **工具**：不直接使用工具，而是通过调用子 Agent 来完成任务。

-   **`legal-retriever-agent` (检索者)**
    -   **职责**：文件检索专家，负责从文件系统中查找和提取信息。
    -   **核心工具**：
        -   `get_all_files`: 获取所有法律文件的路径列表。
        -   `get_file_chunks_info`: 获取单个文件的分块元数据，用于快速预览。
        -   `read_file_chunk`: 读取指定文件的特定分块内容。

-   **`legal-evaluator-agent` (评估者)**
    -   **职责**：法律逻辑评审员，判断检索到的条文是否与用户问题相关。
    -   **工具**：无，纯粹进行逻辑推理和判断。

### 自定义工具

为了安全、高效地处理本地文件，项目实现了专门的文件操作工具，替代了 LangChain 的通用文件工具：

-   `GetAllFilesTool`: 递归扫描指定根目录下的所有文件，返回相对路径列表。
-   `GetFileChunksInfoTool`: 智能分析文件内容，将其分为多个逻辑块（chunk），并返回每个块的摘要信息，而不必一次性读取整个文件。
-   `ReadFileChunkTool`: 根据 `GetFileChunksInfoTool` 提供的信息，精确读取某一个分块的完整内容。

## 🚀 如何运行

### 1. 环境配置

在运行前，请设置必要的环境变量和路径：

-   **模型 API 地址**：
    ```bash
    export OPENAI_API_BASE="http://10.1.30.1:18080/v1"
    export OPENAI_API_KEY="dummy"
    ```

-   **法律文档路径**：
    修改 `contract.py` 文件中的 `LAW_DOCS_PATH` 常量，指向你的本地法律文档库。
    ```python
    # 法律文件检索路径限制
    LAW_DOCS_PATH = r"D:\path\to\your\law\docs"
    ```

### 2. 启动 Agent 服务

本项目使用 `langgraph` 进行部署。通过以下命令启动服务：

```bash
langgraph dev --host 0.0.0.0 --port 22204
```

### 3. 连接 UI 界面

1.  启动 [deep-agents-ui](https://github.com/ys-L/deep-agents-ui) 前端项目。
2.  在 UI 的配置界面，将 Agent 的后端地址指向 `http://localhost:22204`。
3.  开始在 UI 界面上提问和交互。

## 📝 使用示例

**用户问题**:

> "请找到具体的法律条文编号。相关法律内容如下：机关法人可以从事为履行职能所需的民事活动"

**Agent 输出 (成功时)**:

```
根据您提供的合同信息，相关法律依据如下：

**法律条文**：《中华人民共和国民法典》第九十七条

**条文内容**：有独立经费的机关和承担行政职能的法定机构从成立之日起，具有机关法人资格，可以从事为履行职能所需要的民事活动。

**适用理由**：该条文直接规定了机关法人可以从事为履行职能所需的民事活动。

**检索过程**：共进行了 1 次检索，最终匹配成功。
```
